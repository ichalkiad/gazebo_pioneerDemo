<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />


<script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="https://static.robotwebtools.org/roslibjs/current/roslib.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vsup@latest"></script>

<style>
    body {
      font-family: sans-serif;
    }
  </style>

<script>
  // Connecting to ROS
  // -----------------
  var ros = new ROSLIB.Ros();

  // If there is an error on the backend, an 'error' emit will be emitted.
  ros.on('error', function(error) {
    document.getElementById('connecting').style.display = 'none';
    document.getElementById('connected').style.display = 'none';
    document.getElementById('closed').style.display = 'none';
    document.getElementById('error').style.display = 'inline';
    console.log(error);
  });

  // Find out exactly when we made a connection.
  ros.on('connection', function() {
    console.log('Connection made!');
    document.getElementById('connecting').style.display = 'none';
    document.getElementById('error').style.display = 'none';
    document.getElementById('closed').style.display = 'none';
    document.getElementById('connected').style.display = 'inline';
  });

  ros.on('close', function() {
    console.log('Connection closed.');
    document.getElementById('connecting').style.display = 'none';
    document.getElementById('connected').style.display = 'none';
    document.getElementById('closed').style.display = 'inline';
  });

  // Create a connection to the rosbridge WebSocket server.
  ros.connect('ws://localhost:9090');

  //Subscribing to  Topic
  //----------------------
  var listener = new ROSLIB.Topic({
    ros : ros,
    name : '/uncertain',
    messageType : 'p3dx_description/UncertainMsg'
  });

  var msg = [];
  var data = [
              {"Direction":3,"Uncertainty":0.25,"startAngle":-0.78,"endAngle":-0.26,"id":"L","label":"Left"},
              {"Direction":2,"Uncertainty":0.25,"startAngle":-0.26,"endAngle":0.26,"id":"F","label":"Forward"},
              {"Direction":0,"Uncertainty":0.25,"startAngle":0.26,"endAngle":0.78,"id":"SR","label":"SL right"},
              {"Direction":1,"Uncertainty":0.25,"startAngle":0.78,"endAngle":1.30,"id":"R","label":"Right"}
  ];
  //-------------------------------------------

  function visualize_vsup(data) {
  
        var id     = data.map(function(d) { return d.id; });
        var sAngle = data.map(function(d) { return d.startAngle; });
        var eAngle = data.map(function(d) { return d.endAngle; });

        var val = data.map(function(d) { return d.Direction;   });
        var unc = data.map(function(d) { return d.Uncertainty; });
  

        var vDom = d3.extent(data.map(function(d) { return d.Direction; }));
        var uDom = d3.extent(data.map(function(d) { return d.Uncertainty; }));

        var uDomScale = d3.extent(data.map(function(d) { return 1.0-d.Uncertainty; }));

        var quantization = vsup.quantization().branching(2).layers(3).valueDomain(vDom).uncertaintyDomain(uDomScale);
        var scale = vsup.scale().quantize(quantization).range(d3.interpolateViridis);

        var squareQuantization = vsup.squareQuantization().n(4).valueDomain(vDom).uncertaintyDomain(uDom);
        var squareScale = vsup.scale().quantize(squareQuantization).range(d3.interpolateViridis);

        var simpleScale = d3.scaleQuantize().domain([0, 1]).range(d3.quantize(d3.interpolateViridis, 4));
        var body = d3.select("body");

        var w = 860;
        var h = 440;
        radius = Math.min(w, h) / 2,
        innerRadius = 0.2 * radius;

        d3.selectAll("svg.test").remove();      
        makeVSUP(w, h, scale, simpleScale, data, "arc",unc,val,sAngle,eAngle,id);

      };


      function makeVSUP(w, h, scale, simpleScale, data, type, unc,val,sAngle,eAngle,id) {
                 
        var pie = d3.pie()
                    .sort(null)
                    .value(function(d,i) { return unc[i]; } );

        
        var arc = d3.arc()
                        .innerRadius(innerRadius)
                        .outerRadius(function (d,i) { 
                            return (radius - innerRadius) * unc[i]*2 + innerRadius; 
                        })
                        .startAngle(function(d,i) {return sAngle[i];})
                        .endAngle(function(d,i) {return eAngle[i];});

        var svg = d3.select("body").append("svg")
                                   .attr("class","test")
                                   .attr("width", w)
                                   .attr("height", h)
                                   .append("g")
                                   .attr("transform", "translate(5,400)");

        var arcEnter = svg.selectAll(".solidArc")
            .data(pie(unc))
            .enter().append("g")
            .classed("solidArc", true)
            .attr("transform", "translate(200,50)");

        arcEnter.append("path")
            .attr("fill", function(d,i) {return scale(val[i],1.0-unc[i]);})
            .attr("id", function(d,i) {return id[i];})
            .attr("stroke", "gray")
            .attr("d", arc);


        /*
        arcEnter.append("text")
                .style("font-size", 13)
                .style("text-anchor", "middle")
                .attr("y", -10)
                .attr("xlink:href", function(d){return d.data.id;}) 
                .text(function(d) {return d.data.label;})
                .attr("transform", function(d) {
                        return "rotate(0.7)translate(0,0)"});
        */
      
       makeLegend(svg, w, scale, data, type);        
     
      
      }

      function makeLegend(svg, w, scale, data, type) {

        var legend = type === "arc" ? vsup.legend.arcmapLegend() : vsup.legend.simpleLegend();

        if (type==="arc") {
            legend
                .scale(scale)
                .size(160)
                .x(500)
                .y(-150)
                .vtitle("Direction")
                .utitle("Danger of collision");
        } else {
             legend
                .scale(scale)
                .size(160)
                .height(40)
                .x(150)
                .y(60)
                .title("Danger of collision");
        }
        svg.append("g").call(legend)
      }
      
  
//-------------------------------------------


  


  // Callback to be called every time a message is published on this topic.
  listener.subscribe(function(message) {
  console.log('Received message on ' + listener.name + ': ' + message.UncertainList);
        msg[0] = message.UncertainList[0];
        msg[1] = message.UncertainList[1];
        msg[2] = message.UncertainList[2];
        msg[3] = message.UncertainList[3];

        var data = [
              {"Direction":3,"Uncertainty":0.25,"startAngle":-0.78,"endAngle":-0.26,"id":"L","label":"Left"},
              {"Direction":2,"Uncertainty":0.25,"startAngle":-0.26,"endAngle":0.26,"id":"F","label":"Forward"},
              {"Direction":0,"Uncertainty":0.25,"startAngle":0.26,"endAngle":0.78,"id":"SR","label":"SL right"},
              {"Direction":1,"Uncertainty":0.25,"startAngle":0.78,"endAngle":1.30,"id":"R","label":"Right"}
        ];

        if (msg !== undefined) {
           if (msg.length != 0) {
            data[0].Uncertainty = msg[3];      
            data[1].Uncertainty = msg[2];      
            data[2].Uncertainty = msg[0];      
            data[3].Uncertainty = msg[1];      
           }
        }

          
       visualize_vsup(data);
  
    // If desired, we can unsubscribe from the topic as well.
    //listener.unsubscribe();
  });

</script>
<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
  
  <!--h1>Simple roslib Example</h1>
  <p>Run the following commands in the terminal then refresh this page. Check the JavaScript
    console for the output.</p>
  <ol>
    <li><tt>roscore</tt></li>
    <li><tt>rostopic pub /listener std_msgs/String "Hello, World"</tt></li>
    <li><tt>rostopic echo /cmd_vel</tt></li>
    <li><tt>rosrun rospy_tutorials add_two_ints_server</tt></li>
    <li><tt>roslaunch rosbridge_server rosbridge_websocket.launch</tt></li>
  </ol-->
  <h1>Test</h1>
  <div id="statusIndicator">
    <p id="connecting">
      Connecting to rosbridge...
    </p>
    <p id="connected" style="color:#00D600; display:none">
      Connected
    </p>
    <p id="error" style="color:#FF0000; display:none">
      Error in the backend!
    </p>
    <p id="closed" style="display:none">
      Connection closed.
    </p>
  </div>

  
</body>
</html>
