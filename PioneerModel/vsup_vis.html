<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />


<script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="https://static.robotwebtools.org/roslibjs/current/roslib.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vsup@latest"></script>

<style>
    body {
      font-family: sans-serif;
    }
  </style>

<script>
  // Connecting to ROS
  // -----------------
  var ros = new ROSLIB.Ros();

  // If there is an error on the backend, an 'error' emit will be emitted.
  ros.on('error', function(error) {
    document.getElementById('connecting').style.display = 'none';
    document.getElementById('connected').style.display = 'none';
    document.getElementById('closed').style.display = 'none';
    document.getElementById('error').style.display = 'inline';
    console.log(error);
  });

  // Find out exactly when we made a connection.
  ros.on('connection', function() {
    console.log('Connection made!');
    document.getElementById('connecting').style.display = 'none';
    document.getElementById('error').style.display = 'none';
    document.getElementById('closed').style.display = 'none';
    document.getElementById('connected').style.display = 'inline';
  });

  ros.on('close', function() {
    console.log('Connection closed.');
    document.getElementById('connecting').style.display = 'none';
    document.getElementById('connected').style.display = 'none';
    document.getElementById('closed').style.display = 'inline';
  });

  // Create a connection to the rosbridge WebSocket server.
  ros.connect('ws://localhost:9090');

  //Subscribing to  Topic
  //----------------------
  var listener = new ROSLIB.Topic({
    ros : ros,
    name : '/uncertain',
    messageType : 'p3dx_description/UncertainMsg'
  });

  var msg = [];
  var data = [
              {"Direction":3,"Uncertainty":0.1,"startAngle":-0.78,"endAngle":-0.26,"id":"L","label":"Left"},
              {"Direction":2,"Uncertainty":0.7,"startAngle":-0.26,"endAngle":0.26,"id":"F","label":"Forward"},
              {"Direction":0,"Uncertainty":0.1,"startAngle":0.26,"endAngle":0.78,"id":"SR","label":"SL right"},
              {"Direction":1,"Uncertainty":0.1,"startAngle":0.78,"endAngle":1.30,"id":"R","label":"Right"}
  ];
  var opacity = [1.0,0.2,0.2];
  var max_prob = 0.25;
  var collision = 0;
  var variance_threshold = 0.70;
  

  //-------------------------------------------

  function visualise_vsup(data,max_prob,collision) {

        var label  = data.map(function(d) { return d.label; });
        var id     = data.map(function(d) { return d.id; });
        var sAngle = data.map(function(d) { return d.startAngle; });
        var eAngle = data.map(function(d) { return d.endAngle; });

        var val = data.map(function(d) { return d.Direction;   });
        var unc = data.map(function(d) { return d.Uncertainty; });
  

        var vDom = d3.extent(data.map(function(d) { return d.Direction; }));
        var uDom = d3.extent(data.map(function(d) { return d.Uncertainty; }));

        var uDomScale = d3.extent(data.map(function(d) { return 1.0-d.Uncertainty; }));

        var quantization = vsup.quantization().branching(2).layers(2).valueDomain(vDom).uncertaintyDomain(uDomScale);
        var scale = vsup.scale().quantize(quantization).range(d3.interpolateViridis);

        var squareQuantization = vsup.squareQuantization().n(4).valueDomain(vDom).uncertaintyDomain(uDom);
        var squareScale = vsup.scale().quantize(squareQuantization).range(d3.interpolateViridis);

        var simpleScale = d3.scaleQuantize().domain([0,1]).range(d3.quantize(d3.interpolateViridis, 5));
        

        var body = d3.select("body");

        var w = 1280;
        var h = 840;
        radius = Math.min(w, h) / 3,
        innerRadius = 0.2*radius;

        d3.selectAll("svg.canvas").remove();      
        makeVSUP(w, h, scale, simpleScale, data, "simple",unc,val,sAngle,eAngle,id,label,max_prob,collision);

      };

      function midAngle(d){
		return d.startAngle + (d.endAngle - d.startAngle)/2;
      }
      function angle(d) {
          var a = (d.startAngle + d.endAngle) * 90 / Math.PI - 90;
          return a > 90 ? a - 180 : a;
      }
  
      function makeVSUP(w, h, scale, simpleScale, data, type, unc,val,sAngle,eAngle,id,label,max_prob,collision) {
                 
        var pie = d3.pie()
                    .sort(null)
                    .value(function(d,i) { return unc[i]; } );

        var arc = d3.arc()
                        .innerRadius(innerRadius)
                        .outerRadius(function (d,i) { 
                            return (radius - innerRadius) * unc[i]*2 + innerRadius; 
                        })
                        .startAngle(function(d,i) {return sAngle[i];})
                        .endAngle(function(d,i) {return eAngle[i];});

       var svg = d3.select("body").append("svg")
                                   .attr("class","canvas")
                                   .attr("width", w)
                                   .attr("height", h)
                                   .append("g")
                                   .attr("transform", "translate("+w/2+","+h/2+")");

       var arcEnter = svg.selectAll(".solidArc")
            .data(pie(unc))
            .enter().append("g")
            .classed("solidArc", true)
            .attr("transform", "translate(-"+w/20+","+h/2+")");

       arcEnter.append("path")
            .attr("fill", function(d,i) {return simpleScale(1.0-unc[i]);})
            .attr("id", function(d,i) {return id[i];})
            .attr("stroke", "gray")
            .attr("d", arc);



       var max_prob = data[0].Uncertainty;
       direction = "Left";
       if (data[1].Uncertainty > max_prob) {
           max_prob = data[1].Uncertainty;
           direction = "Forward";
       }
       if (data[2].Uncertainty > max_prob) {
           max_prob = data[2].Uncertainty;
           direction = "Slightly Right";
       }
       if (data[3].Uncertainty > max_prob) {
           max_prob = data[3].Uncertainty;
       direction = "Right";
       }
  
  
       svg.append("text")
          .attr("class", "direction")
          .attr("dy", ".35em")
          .attr("transform","translate(-"+w/3+","+h/2.5+")")
          .text(direction);                            
  


       makeLegend(svg, h, w, simpleScale, data, type);        
       create_circles(svg,h,w,max_prob,collision);     

 }

  function create_circles(svg,h,w,max_prob,collision) {
        var opacity = [1.0,0.2,0.2]
        if (max_prob < variance_threshold) {
           opacity[0] =  0.2
           opacity[1] = 1.0
           opacity[2] = 0.2
        }
        else if (max_prob > variance_threshold) {
           opacity[0] =  1.0
           opacity[1] = 0.2
           opacity[2] = 0.2

	}
        if (collision) {
           opacity[0] = 0.2
           opacity[1] = 0.2
           opacity[2] = 1.0
        }

          console.log(opacity)
          var jsonCircles = [
                       { "x_axis": 50, "y_axis": -150 , "radius": 30, "color" : "green", "opacity" :opacity[0] },
                       { "x_axis":  250, "y_axis": -150, "radius": 30, "color" : "yellow", "opacity" :opacity[1]},
                       { "x_axis": 450, "y_axis": -150, "radius": 30, "color" : "red", "opacity" :opacity[2]}];

    
          var circles = svg.selectAll("circle")
                           .data(jsonCircles)
                           .enter()
                           .append("circle");

  

          var circleAttributes = circles
                       .attr("cx", function (d) { return d.x_axis; })
                       .attr("cy", function (d) { return d.y_axis; })
                       .attr("r", function (d) { return d.radius; })
                       .style("fill", function(d) { return d.color; })
                       .style("opacity", function(d) { return d.opacity; });


          if (opacity[0]===1){
              var robotState = "Inspecting..."
          } else if (opacity[1]===1){
              var robotState = "I am confused..."
          } else if (opacity[2]===1){
              var robotState = "Collided!"
          }

          
          svg.append("text")
             .attr("class", "state")
             .attr("dy", ".35em")
             .attr("transform","translate("+150+",-"+250+")")
             .text(robotState)


          d3.select("text.state")
           .transition()
           .duration(2500)
           .on("start", function repeat() {
                     var t = d3.active(this)
                     .style("opacity", 0)
                     .text("Moving...")
                     .transition(t)
                     .style("opacity", 1)
                     .text(robotState)
                     .delay(2000)
               });


    
    
      }
  
      function makeLegend(svg, h, w, scale, data, type) {

        var legend = type === "arc" ? vsup.legend.arcmapLegend() : vsup.legend.simpleLegend();

        if (type==="arc") {
            legend
                .scale(scale)
                .size(160)
                .x(w/3)
                .y(h/3)
                .vtitle("Direction")
                .utitle("Danger of collision");
        } else {
             legend
                .scale(scale)
                .size(160)
                .height(40)
                .x(w/3)
                .y(h/3)
                .title("Danger of collision");
        }
        svg.append("g").call(legend)
        if (type==="arc") {
                //remove Value axis
                var leg = svg.select(".legend")
                console.log(leg)
                var tmp = leg._groups[0][0].childNodes[2];
                leg._groups[0][0].removeChild(tmp);
                tmp = leg._groups[0][0].childNodes[2];
                leg._groups[0][0].removeChild(tmp);
        }         
      }
      
  
//-------------------------------------------


  


  // Callback to be called every time a message is published on this topic.
  listener.subscribe(function(message) {
  console.log('Received message on ' + listener.name + ': ' + message.UncertainList);
        msg[0] = message.UncertainList[0];
        msg[1] = message.UncertainList[1];
        msg[2] = message.UncertainList[2];
        msg[3] = message.UncertainList[3];

        var max_prob = message.UncertainList[4];
        var collision = message.UncertainList[5]; //binary
  
        var data = [
              {"Direction":3,"Uncertainty":0.25,"startAngle":-0.78,"endAngle":-0.26,"id":"L","label":"Left"},
              {"Direction":2,"Uncertainty":0.25,"startAngle":-0.26,"endAngle":0.26,"id":"F","label":"Forward"},
              {"Direction":0,"Uncertainty":0.25,"startAngle":0.26,"endAngle":0.78,"id":"SR","label":"SL right"},
              {"Direction":1,"Uncertainty":0.25,"startAngle":0.78,"endAngle":1.30,"id":"R","label":"Right"}
        ];

				       
        if (msg !== undefined) {
           if (msg.length != 0) {
            data[0].Uncertainty = msg[3];      
            data[1].Uncertainty = msg[2];      
            data[2].Uncertainty = msg[0];      
            data[3].Uncertainty = msg[1];      
           }
        }

          
        visualise_vsup(data,max_prob, collision);
           
  
    // If desired, we can unsubscribe from the topic as well.
    //listener.unsubscribe();
  });

</script>
<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
   
  <!--h1>Simple roslib Example</h1>
  <p>Run the following commands in the terminal then refresh this page. Check the JavaScript
    console for the output.</p>
  <ol>
    <li><tt>roscore</tt></li>
    <li><tt>rostopic pub /listener std_msgs/String "Hello, World"</tt></li>
    <li><tt>rostopic echo /cmd_vel</tt></li>
    <li><tt>rosrun rospy_tutorials add_two_ints_server</tt></li>
    <li><tt>roslaunch rosbridge_server rosbridge_websocket.launch</tt></li>
  </ol-->
  <h1></h1>
  <div id="statusIndicator">
    <p id="connecting">
      Connecting to rosbridge...
    </p>
    <p id="connected" style="color:#00D600; display:none">
      Connected
    </p>
    <p id="error" style="color:#FF0000; display:none">
      Error in the backend!
    </p>
    <p id="closed" style="display:none">
      Connection closed.
    </p>
  </div>
  <div class="outer">
      <div class="middle">
	      <div class="inner">
		<script>visualise_vsup(data,max_prob,collision);
                </script>
	      </div>
	</div>
  </div>
</body>
</html>
